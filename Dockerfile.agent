# Dockerfile.agent - Used for dynamically created agent containers
FROM rust:1.79-slim-bookworm AS base
 
# Install Python + venv support
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    python3 python3-venv python3-pip python3-dev \
    build-essential curl pkg-config libssl-dev \
 && rm -rf /var/lib/apt/lists/*

# Create and activate venv
ENV VENV_DIR=/opt/venv
RUN python3 -m venv $VENV_DIR
ENV PATH="$VENV_DIR/bin:$PATH"

# Install the 'uv' CLI
RUN pip install uv

WORKDIR /app

# Copy dependency descriptors
COPY pyproject.toml uv.lock ./

# Sync deps
RUN uv venv --python python3 $VENV_DIR \
 && uv sync

# Copy your sn43 code
COPY sn43 /app/sn43
COPY envs /app/envs

# Install the package
ENV VIRTUAL_ENV=$VENV_DIR
RUN uv pip install -e .

# Set environment
ENV PYTHONPATH=/app

# Expose the port
EXPOSE 5005

# CRITICAL: Start uvicorn as the main process
# This will automatically load /app/agent.py if it exists
# CMD ["/opt/venv/bin/python", "-m", "uvicorn", "sn43:app", "--host", "0.0.0.0", "--port", "5005"]
CMD ["/bin/sh", "-c", "/opt/venv/bin/python -m uvicorn sn43:app --host 0.0.0.0 --port ${PORT:-5005}"]